# Implementation Plan: AI-Powered Todo Chatbot

**Branch**: `001-ai-chatbot` | **Date**: 2026-02-15 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-ai-chatbot/spec.md`

## Summary

Implement an AI-powered chatbot interface that enables users to manage todo tasks through natural language commands. The chatbot will integrate with the existing Phase II web application (Next.js frontend + FastAPI backend) using OpenAI ChatKit, Agents SDK, and MCP SDK for intent parsing and conversation management. Users can create, complete, query, update, and delete tasks by typing conversational commands instead of using traditional UI forms.

## Technical Context

**Language/Version**: TypeScript 5.x (frontend), Python 3.11+ (backend)
**Primary Dependencies**:
- Frontend: Next.js 14+, React 18+, OpenAI ChatKit, Agents SDK (TypeScript)
- Backend: FastAPI, OpenAI Python SDK, MCP SDK
**Storage**: Existing Neon DB (PostgreSQL) - no schema changes required
**Testing**: Jest + React Testing Library (frontend), pytest (backend)
**Target Platform**: Web browser (responsive design)
**Project Type**: Web application (frontend + backend extension)
**Performance Goals**:
- Chatbot response time <2 seconds (95th percentile)
- Intent parsing <500ms
- UI remains responsive during API calls
**Constraints**:
- No complex infrastructure (Phase IV/V only)
- Must integrate with existing Phase II backend API without modifying core task service
- No persistent chat history across sessions (session storage only)
- English language only (Urdu is bonus feature)
**Scale/Scope**:
- Single-user chat sessions
- Support 5+ concurrent operations per session
- Handle 3+ phrasings per operation type

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### Phase III Requirements (from Constitution)

✅ **Allowed Technologies**: OpenAI ChatKit, OpenAI Agents SDK, MCP SDK
✅ **Natural Language Processing**: Intent parsing for todo management
✅ **Integration Requirement**: Must work with existing Phase II web app
✅ **Separation of Concerns**: Intent parsing separated from execution logic
✅ **No Complex Infrastructure**: Deployment complexity reserved for Phase IV/V
✅ **Disallowed**: Cloud deployment, complex orchestration

### Core Principles Compliance

✅ **Spec-First Mandate**: This plan follows approved specification
✅ **No Manual Code Rule**: Implementation will be generated by Claude Code
✅ **Incremental Phase Evolution**: Builds on Phase II, no Phase IV/V features
✅ **Deterministic AI Behavior**: Follows spec literally, no assumptions
✅ **Separation of Concerns**: Business logic (tasks) decoupled from AI layer (chatbot)

### AI Agent Governance Compliance

✅ **Intent Parsing vs Execution Separation**: Distinct parsing and execution modules
✅ **Use of OpenAI ChatKit**: For conversation interface
✅ **Use of Agents SDK & MCP**: For intent parsing and context management
✅ **Safety, Determinism, Traceability**: Error handling and logging required

**Gate Status**: ✅ PASSED - All constitutional requirements satisfied

## Project Structure

### Documentation (this feature)

```text
specs/001-ai-chatbot/
├── spec.md              # Feature specification (completed)
├── plan.md              # This file (in progress)
├── research.md          # Phase 0 output (to be created)
├── data-model.md        # Phase 1 output (to be created)
├── quickstart.md        # Phase 1 output (to be created)
├── contracts/           # Phase 1 output (to be created)
│   ├── chatbot-api.yaml # Backend chatbot endpoints
│   └── intent-schema.json # Intent parsing data structures
├── checklists/
│   └── requirements.md  # Spec validation (completed)
└── tasks.md             # Phase 2 output (/sp.tasks command - NOT created by /sp.plan)
```

### Source Code (repository root)

```text
web_todo_app/
├── backend/
│   ├── src/
│   │   ├── models/          # Existing task models (no changes)
│   │   ├── services/        # Existing task service (no changes)
│   │   ├── api/
│   │   │   ├── routes/      # Existing task routes (no changes)
│   │   │   └── chatbot/     # NEW: Chatbot endpoints
│   │   │       ├── __init__.py
│   │   │       ├── routes.py
│   │   │       └── schemas.py
│   │   ├── chatbot/         # NEW: Chatbot core logic
│   │   │   ├── __init__.py
│   │   │   ├── intent_parser.py    # Intent identification
│   │   │   ├── task_executor.py    # Task operations
│   │   │   ├── response_generator.py # Conversational responses
│   │   │   └── context_manager.py  # Session context (MCP)
│   │   └── config.py        # Add OpenAI API key config
│   └── tests/
│       ├── unit/
│       │   └── chatbot/     # NEW: Unit tests for chatbot logic
│       └── integration/
│           └── chatbot/     # NEW: Integration tests
│
└── frontend/
    ├── src/
    │   ├── components/
    │   │   └── chatbot/     # NEW: Chat UI components
    │   │       ├── ChatInterface.tsx
    │   │       ├── ChatMessage.tsx
    │   │       ├── ChatInput.tsx
    │   │       └── ChatHistory.tsx
    │   ├── pages/
    │   │   └── chat.tsx     # NEW: Chat page
    │   ├── services/
    │   │   └── chatbot.ts   # NEW: Chatbot API client
    │   ├── hooks/
    │   │   └── useChat.ts   # NEW: Chat state management
    │   └── types/
    │       └── chatbot.ts   # NEW: Chat type definitions
    └── tests/
        └── chatbot/         # NEW: Frontend chatbot tests
```

**Structure Decision**: Extending the existing web application structure (Option 2: Web application) by adding new chatbot-specific modules to both frontend and backend. The existing task management code remains unchanged, ensuring separation of concerns between the AI layer and business logic layer.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

No violations detected. All complexity is justified by Phase III constitutional requirements.

## Phase 0: Research & Technology Decisions

### Research Tasks

1. **OpenAI ChatKit Integration**
   - Research: How to integrate ChatKit into Next.js frontend
   - Research: ChatKit conversation state management patterns
   - Research: ChatKit API authentication and configuration

2. **OpenAI Agents SDK Usage**
   - Research: Best practices for intent parsing with Agents SDK
   - Research: How to structure agent prompts for task management domain
   - Research: Error handling patterns in Agents SDK

3. **MCP SDK Implementation**
   - Research: MCP SDK setup for conversation context management
   - Research: Session state persistence patterns (in-memory for Phase III)
   - Research: Context window management for multi-turn conversations

4. **Intent Classification Patterns**
   - Research: Common NLP patterns for CRUD operation detection
   - Research: Entity extraction techniques for task titles/descriptions
   - Research: Ambiguity resolution strategies

5. **Backend Integration Architecture**
   - Research: How to call existing FastAPI endpoints from chatbot service
   - Research: Error propagation from task service to chatbot responses
   - Research: API client patterns in Python

### Technology Decisions

**Decision 1: Frontend Chat Framework**
- **Options**: Custom React components, ChatKit UI library, third-party chat UI
- **Chosen**: OpenAI ChatKit (constitutional requirement)
- **Rationale**: Mandated by Phase III constitution, provides conversation management out of the box

**Decision 2: Intent Parsing Approach**
- **Options**: Rule-based parsing, OpenAI function calling, Agents SDK
- **Chosen**: OpenAI Agents SDK (constitutional requirement)
- **Rationale**: Mandated by Phase III constitution, provides structured intent extraction

**Decision 3: Context Management**
- **Options**: In-memory state, browser localStorage, MCP SDK
- **Chosen**: MCP SDK with session storage (constitutional requirement)
- **Rationale**: Mandated by Phase III constitution, proper context protocol implementation

**Decision 4: Backend Architecture**
- **Options**: Separate chatbot service, extend existing FastAPI app, serverless functions
- **Chosen**: Extend existing FastAPI app with new chatbot module
- **Rationale**: Simplest integration, no infrastructure complexity (Phase III constraint)

**Decision 5: Testing Strategy**
- **Options**: Manual testing only, unit tests only, full test pyramid
- **Chosen**: Unit tests for intent parsing + integration tests for end-to-end flows
- **Rationale**: Ensures intent accuracy (90% requirement) and validates full conversation flows

## Phase 1: Design & Contracts

### Data Model

See [data-model.md](./data-model.md) for complete entity definitions.

**Key Entities**:
- **ChatMessage**: User/bot messages with metadata
- **ChatSession**: Conversation context and history
- **Intent**: Parsed user intent with action type and parameters
- **Task**: Existing entity (no changes)

### API Contracts

See [contracts/](./contracts/) directory for complete API specifications.

**New Endpoints**:
- `POST /api/chatbot/message` - Send user message, receive bot response
- `GET /api/chatbot/session` - Get current session context
- `DELETE /api/chatbot/session` - Clear session context

**Existing Endpoints** (no changes):
- `GET /api/tasks` - List all tasks
- `POST /api/tasks` - Create task
- `PUT /api/tasks/{id}` - Update task
- `DELETE /api/tasks/{id}` - Delete task
- `PATCH /api/tasks/{id}/toggle` - Toggle completion

### Integration Points

1. **Frontend → Backend Chatbot API**: HTTP requests for message processing
2. **Chatbot Service → Task Service**: Internal function calls (not HTTP)
3. **Chatbot Service → OpenAI API**: Intent parsing and response generation
4. **Frontend → Browser Storage**: Session state persistence

### Quickstart Guide

See [quickstart.md](./quickstart.md) for developer setup instructions.

## Phase 2: Task Breakdown

**Note**: Task breakdown is generated by the `/sp.tasks` command, not by `/sp.plan`.

The tasks.md file will be created in the next phase and will include:
- Testable implementation tasks with acceptance criteria
- Dependency ordering (P1 → P2 → P3 → P4 → P5)
- Test cases for each functional requirement
- Integration test scenarios

## Risks & Mitigations

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| OpenAI API rate limits | High | Medium | Implement request throttling, show loading states |
| Intent parsing accuracy <90% | High | Medium | Extensive prompt engineering, fallback to clarification questions |
| ChatKit/Agents SDK breaking changes | Medium | Low | Pin specific versions, monitor release notes |
| Backend API errors not handled gracefully | Medium | Medium | Comprehensive error handling, user-friendly messages |
| Session context lost on page refresh | Low | High | Expected behavior per spec (session storage only) |
| Long response times (>2s) | Medium | Medium | Optimize prompts, implement streaming responses if needed |

## Success Metrics

Aligned with specification success criteria:

- **SC-001**: Task creation <10 seconds (measure: end-to-end timing)
- **SC-002**: Intent accuracy ≥90% (measure: test suite pass rate)
- **SC-003**: Complete workflows via chat only (measure: manual testing)
- **SC-004**: Response time <2 seconds (measure: API monitoring)
- **SC-005**: 80% commands succeed without clarification (measure: analytics)
- **SC-006**: Manage 5+ tasks per session (measure: integration tests)
- **SC-007**: 3+ phrasings per operation (measure: test coverage)

## Next Steps

1. ✅ Complete this plan document
2. ⏳ Generate research.md (Phase 0)
3. ⏳ Generate data-model.md (Phase 1)
4. ⏳ Generate contracts/ (Phase 1)
5. ⏳ Generate quickstart.md (Phase 1)
6. ⏳ Update agent context (Phase 1)
7. ⏳ Run `/sp.tasks` to generate tasks.md (Phase 2)
8. ⏳ Run `/sp.implement` to execute implementation (Phase 3)

---

**Plan Status**: Phase 0 and Phase 1 artifacts generation in progress
**Constitutional Compliance**: ✅ Verified
**Ready for Implementation**: After Phase 0 and Phase 1 completion
